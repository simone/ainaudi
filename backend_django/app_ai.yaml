service: ai
runtime: python311
env: standard
instance_class: F1

entrypoint: bash entrypoint_ai.sh

env_variables:
  DJANGO_SETTINGS_MODULE: config.settings_ai
  GOOGLE_CLOUD_PROJECT: ainaudi-prod
  DEBUG: "false"
  ALLOWED_HOSTS: ".appspot.com,.run.app"

  # Database (Cloud SQL via Unix socket) - read for JWT user lookup + pgvector
  DB_HOST: "/cloudsql/ainaudi-prod:europe-west1:ainaudi-db"
  DB_NAME: "ainaudi_db"
  DB_USER: "postgres"

  # CORS & CSRF Security
  CORS_ALLOWED_ORIGINS: "https://ainaudi-prod.appspot.com"
  CSRF_TRUSTED_ORIGINS: "https://ainaudi-prod.appspot.com"

  # Feature Flags
  FEATURE_AI_ASSISTANT: "true"

  # Vertex AI Configuration (Gemini + Embeddings)
  VERTEX_AI_PROJECT: "ainaudi-prod"
  VERTEX_AI_LOCATION: "europe-west1"

# No static file handlers needed (API-only)
handlers:
  - url: /.*
    script: auto
    secure: always

# Cloud SQL connection
beta_settings:
  cloud_sql_instances: ainaudi-prod:europe-west1:ainaudi-db

# Automatic scaling - scale to zero when idle
automatic_scaling:
  min_instances: 0
  max_instances: 20
  min_idle_instances: 0
  max_idle_instances: 0
  target_cpu_utilization: 0.65
  target_throughput_utilization: 0.65
