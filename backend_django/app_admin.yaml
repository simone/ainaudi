service: admin
runtime: python311
env: standard
instance_class: F1

entrypoint: gunicorn -b :$PORT config.wsgi_admin:application --workers 2 --threads 2

env_variables:
  DJANGO_SETTINGS_MODULE: config.settings_admin
  GOOGLE_CLOUD_PROJECT: ainaudi-prod
  DEBUG: "false"
  ALLOWED_HOSTS: ".appspot.com,.run.app,ainaudi.it,www.ainaudi.it,ainaudi-prod.appspot.com"

  # Database (Cloud SQL via Unix socket)
  DB_HOST: "/cloudsql/ainaudi-prod:europe-west1:ainaudi-db"
  DB_NAME: "ainaudi_db"
  DB_USER: "postgres"

  # Google Cloud Storage (Media Files)
  USE_GCS: "true"
  GCS_BUCKET_NAME: "ainaudi-documents"
  GS_BUCKET_NAME: "ainaudi-documents"
  GS_DEFAULT_ACL: "publicRead"

  # CORS & CSRF Security
  CORS_ALLOWED_ORIGINS: "https://ainaudi-prod.appspot.com,https://ainaudi.it,https://www.ainaudi.it"
  CSRF_TRUSTED_ORIGINS: "https://ainaudi-prod.appspot.com,https://ainaudi.it,https://www.ainaudi.it"


  # Email (for admin Magic Link)
  EMAIL_BACKEND: "django.core.mail.backends.smtp.EmailBackend"
  EMAIL_HOST: "smtp.gmail.com"
  EMAIL_PORT: "587"
  EMAIL_USE_TLS: "True"
  EMAIL_HOST_USER: "s.federici@gmail.com"
  DEFAULT_FROM_EMAIL: "AINAUDI (M5S) <noreply@ainaudi.it>"

  # Frontend URL
  FRONTEND_URL: "https://ainaudi.it"

  # Feature Flags (all enabled for admin management)
  FEATURE_MAGIC_LINK: "true"
  FEATURE_TEMPLATES_ENGINE: "true"

handlers:
  # Admin static files (CSS/JS/fonts) - cache 6 months
  - url: /static/admin
    static_dir: staticfiles/admin/
    secure: always
    expiration: 180d

  # DRF static files
  - url: /static/rest_framework
    static_dir: staticfiles/rest_framework/
    secure: always
    expiration: 180d

  # Other static files
  - url: /static
    static_dir: staticfiles/
    secure: always

  # All other requests go to Django
  - url: /.*
    script: auto
    secure: always

# Cloud SQL connection
beta_settings:
  cloud_sql_instances: ainaudi-prod:europe-west1:ainaudi-db

# Automatic scaling - scale to zero, few admins
automatic_scaling:
  min_instances: 0
  max_instances: 2
  min_idle_instances: 0
  max_idle_instances: 0
  target_cpu_utilization: 0.65
